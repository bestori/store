<!DOCTYPE html>
<html lang="{% if session.get('preferred_language') == 'english' %}en{% else %}he{% endif %}"
    dir="{% if session.get('preferred_language') == 'english' %}ltr{% else %}rtl{% endif %}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Store - חנות{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif, 'David', 'Arial Hebrew';
            background-color: #f8f9fa;

                {
                % if session.get('preferred_language') !='english' %
            }

            direction: rtl;
            text-align: right;

                {
                % endif %
            }
        }

        .navbar-brand {
            font-weight: bold;
            color: var(--primary-color) !important;
        }

        .main-content {
            min-height: calc(100vh - 200px);
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        /* Hebrew/RTL specific styles */
        .rtl-support {
                {
                % if session.get('preferred_language') !='english' %
            }

            direction: rtl;
            text-align: right;

                {
                % endif %
            }
        }

        .search-results .card {
            margin-bottom: 1rem;
        }

        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        /* Enhanced Loading States */
        .loading-spinner {
            display: none;
        }

        .loading .loading-spinner {
            display: inline-block;
        }

        /* Button loading states */
        .btn-loading {
            position: relative;
            pointer-events: none;
        }

        .btn-loading .btn-text {
            opacity: 0;
        }

        .btn-loading .btn-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-loading:not(.btn-loading) .btn-spinner {
            display: none;
        }

        /* Pulse animation for loading */
        .btn-loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .alert {
            border-radius: 0.375rem;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Footer */
        .footer {
            background-color: #343a40;
            color: white;
            padding: 2rem 0;
            margin-top: auto;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-content {
                padding-top: 1rem;
                padding-bottom: 1rem;
            }

            .navbar-nav {
                text-align: center;
            }
        }

        /* Language switch */
        .language-switch {
            font-size: 0.875rem;
        }

        /* Shopping list badge */
        .shopping-list-badge {
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            margin-left: 0.25rem;
        }

            {
            % if session.get('preferred_language') !='english' %
        }

        .shopping-list-badge {
            margin-right: 0.25rem;
            margin-left: 0;
        }

            {
            % endif %
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>

<body class="d-flex flex-column min-vh-100">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('search.search_page') }}">
                <i class="bi bi-lightning-charge-fill"></i>
                {% if session.get('preferred_language') == 'english' %}
                Store
                {% else %}
                חנות
                {% endif %}
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {% if session.get('user_code') %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('search.search_page') }}">
                            <i class="bi bi-search"></i>
                            {% if session.get('preferred_language') == 'english' %}Search{% else %}חיפוש{% endif %}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('shopping_list.shopping_lists_page') }}">
                            <i class="bi bi-cart3"></i>
                            {% if session.get('preferred_language') == 'english' %}Shopping Lists{% else %}רשימות
                            קניות{% endif %}
                            <span class="shopping-list-badge" id="shopping-list-count" style="display: none;">0</span>
                        </a>
                    </li>
                    {% endif %}
                </ul>

                <ul class="navbar-nav">
                    {% if session.get('user_code') %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                            {{ session.get('user_code') }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('auth.profile') }}">
                                    <i class="bi bi-person"></i>
                                    {% if session.get('preferred_language') == 'english' %}Profile{% else %}פרופיל{%
                                    endif %}
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                                    <i class="bi bi-box-arrow-right"></i>
                                    {% if session.get('preferred_language') == 'english' %}Logout{% else %}התנתקות{%
                                    endif %}
                                </a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('auth.login') }}">
                            <i class="bi bi-box-arrow-in-right"></i>
                            {% if session.get('preferred_language') == 'english' %}Login{% else %}התחברות{% endif %}
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="container mt-3">
        {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
            role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main class="main-content flex-grow-1">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer bg-dark text-light">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>
                        {% if session.get('preferred_language') == 'english' %}
                        Store
                        {% else %}
                        חנות
                        {% endif %}
                    </h5>
                </div>
                <div class="col-md-6 text-md-end">
                    <small class="text-muted">
                        &copy; 2025 Store |
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        // CSRF Token for AJAX requests
        const csrfToken = {% if config.WTF_CSRF_ENABLED %}'{{ csrf_token() }}'{% else %}null{% endif %};
        
        // Global JavaScript functions

        // Enhanced Button Loading State Management
        function setButtonLoading(button, isLoading, loadingText = null) {
            if (!button) return;
            
            if (isLoading) {
                // Store original state
                if (!button.hasAttribute('data-original-text')) {
                    button.setAttribute('data-original-text', button.innerHTML);
                }
                
                // Set loading state
                button.classList.add('btn-loading');
                button.disabled = true;
                
                // Create loading content
                const originalText = button.getAttribute('data-original-text');
                const spinnerHtml = '<span class="spinner-border spinner-border-sm me-2"></span>';
                const textToShow = loadingText || getLoadingText(button);
                
                button.innerHTML = `
                    <span class="btn-text">${originalText}</span>
                    <span class="btn-spinner">
                        ${spinnerHtml}
                        <span>${textToShow}</span>
                    </span>
                `;
            } else {
                // Restore original state
                button.classList.remove('btn-loading');
                button.disabled = false;
                
                const originalText = button.getAttribute('data-original-text');
                if (originalText) {
                    button.innerHTML = originalText;
                    button.removeAttribute('data-original-text');
                }
            }
        }
        
        // Get appropriate loading text based on button context
        function getLoadingText(button) {
            const buttonText = button.textContent.toLowerCase().trim();
            const isHebrew = '{{ session.get("preferred_language") != "english" }}' === 'True';
            
            // Common button text mappings
            const loadingTexts = {
                // English mappings
                'login': 'Logging in...',
                'search': 'Searching...',
                'filter': 'Filtering...',
                'submit': 'Submitting...',
                'save': 'Saving...',
                'create': 'Creating...',
                'update': 'Updating...',
                'delete': 'Deleting...',
                'add': 'Adding...',
                'remove': 'Removing...',
                'send': 'Sending...',
                'upload': 'Uploading...',
                'download': 'Downloading...',
                'export': 'Exporting...',
                'import': 'Importing...',
                'copy': 'Copying...',
                'duplicate': 'Duplicating...',
                
                // Hebrew mappings
                'התחברות': 'מתחבר...',
                'חפש': 'מחפש...',
                'סנן': 'מסנן...',
                'שלח': 'שולח...',
                'שמור': 'שומר...',
                'צור': 'יוצר...',
                'עדכן': 'מעדכן...',
                'מחק': 'מוחק...',
                'הוסף': 'מוסיף...',
                'הסר': 'מסיר...',
                'העלה': 'מעלה...',
                'הורד': 'מוריד...',
                'יצא': 'מייצא...',
                'ייבא': 'מייבא...',
                'העתק': 'מעתיק...',
                'שכפל': 'משכפל...'
            };
            
            // Find matching loading text
            for (const [key, value] of Object.entries(loadingTexts)) {
                if (buttonText.includes(key.toLowerCase())) {
                    return value;
                }
            }
            
            // Default fallback
            return isHebrew ? 'טוען...' : 'Loading...';
        }

        // Show loading state (legacy compatibility)
        function showLoading(element) {
            if (element) {
                element.classList.add('loading');
                const button = element.querySelector('button[type="submit"]') || element;
                if (button.tagName === 'BUTTON') {
                    setButtonLoading(button, true);
                } else if (button) {
                    setButtonLoading(button, true);
                }
            }
        }

        // Hide loading state (legacy compatibility)
        function hideLoading(element) {
            if (element) {
                element.classList.remove('loading');
                const button = element.querySelector('button[type="submit"]') || element;
                if (button.tagName === 'BUTTON') {
                    setButtonLoading(button, false);
                } else if (button) {
                    setButtonLoading(button, false);
                }
            }
        }
        
        // Auto-detect and handle form submissions
        function setupFormLoadingStates() {
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    const submitButton = form.querySelector('button[type="submit"]');
                    if (submitButton) {
                        setButtonLoading(submitButton, true);
                        
                        // Auto-hide loading after 10 seconds as fallback
                        setTimeout(() => {
                            setButtonLoading(submitButton, false);
                        }, 10000);
                    }
                });
            });
        }
        
        // Setup click handlers for buttons with data-loading attribute
        function setupButtonLoadingStates() {
            document.querySelectorAll('button[data-loading], .btn[data-loading]').forEach(button => {
                button.addEventListener('click', function(e) {
                    const loadingText = button.getAttribute('data-loading');
                    setButtonLoading(button, true, loadingText);
                    
                    // Auto-hide loading after reasonable time as fallback
                    setTimeout(() => {
                        setButtonLoading(button, false);
                    }, 8000);
                });
            });
        }

        // Show alert
        function showAlert(message, type = 'info', container = null) {
            const alertContainer = container || document.querySelector('.container');
            if (!alertContainer) return;

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            alertContainer.insertBefore(alertDiv, alertContainer.firstChild);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // AJAX helper function
        function makeRequest(url, options = {}) {
            const defaults = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            const config = Object.assign({}, defaults, options);
            
            // Add CSRF token for POST requests
            if ((config.method === 'POST' || config.method === 'PUT' || config.method === 'DELETE') && csrfToken) {
                if (config.body && typeof config.body === 'string') {
                    // For JSON requests
                    const bodyObj = JSON.parse(config.body);
                    bodyObj.csrf_token = csrfToken;
                    config.body = JSON.stringify(bodyObj);
                } else if (config.body instanceof FormData) {
                    // For FormData requests
                    config.body.append('csrf_token', csrfToken);
                } else {
                    // For other requests, add as header
                    config.headers['X-CSRFToken'] = csrfToken;
                }
            }

            return fetch(url, config)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Request failed:', error);
                    throw error;
                });
        }

        // Update shopping list count in navbar
        function updateShoppingListCount() {
            // This would be implemented to show active shopping list count
            // For now, just hide the badge
            const badge = document.getElementById('shopping-list-count');
            if (badge) {
                badge.style.display = 'none';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateShoppingListCount();
            setupFormLoadingStates();
            setupButtonLoadingStates();
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>